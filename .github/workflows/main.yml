name: Fullstack App CI/CD for Azure VM

on:
  push:
    branches:
      - main

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: List directory for debug
        run: |
          echo "ðŸ“‚ Listing project files..."
          ls -R

      - name: Python Syntax Check (Backend)
        run: |
          echo "ðŸ” Running Python syntax checks..."
          python3 -m py_compile Automation_Test-main/CI_CD_DummyCode/backend/app.py

      - name: Create ZIP Artifact
        run: |
          echo "ðŸ“¦ Creating ZIP build artifact..."
          zip -r fullstack-app-build.zip Automation_Test-main/CI_CD_DummyCode -x "*.git*" "*.github*"

      - name: Upload to JFrog Artifactory
        run: |
          echo "â¬†ï¸ Uploading to JFrog Artifactory..."
          curl -H "X-JFrog-Art-Api: ${{ secrets.ARTIFACTORY_API_KEY }}" \
               -T fullstack-app-build.zip \
               "${{ secrets.ARTIFACTORY_URL }}/${{ secrets.ARTIFACTORY_REPO }}/fullstack-app/fullstack-app-build-${{ github.run_number }}.zip"

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Deploy Code to Azure VM
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
            set -e

            echo "ðŸ“ Checking deployment directory..."

            # Define target directory
            REPO_DIR=~/nextwealth

            # If directory doesnâ€™t exist, clone fresh
            if [ ! -d "$REPO_DIR/.git" ]; then
              echo "ðŸ“¥ Cloning repository for the first time..."
              rm -rf "$REPO_DIR"
              git clone https://github.com/Ayeesha208/nextwealth.git "$REPO_DIR"
            else
              echo "ðŸ” Resetting repository and pulling latest changes..."
              cd "$REPO_DIR"
              git reset --hard HEAD
              git clean -fd
              git pull
            fi

            cd "$REPO_DIR/Automation_Test-main/CI_CD_DummyCode/backend"

            echo "ðŸ Setting up Python virtual environment..."
            python3 -m venv venv
            source venv/bin/activate
            pip install -r ../../requirements.txt

            echo "ðŸ›‘ Stopping existing backend..."
            pkill -f app.py || true

            echo "ðŸš€ Starting backend..."
            nohup python3 app.py > backend.log 2>&1 &

            echo "ðŸŒ Starting frontend server..."
            cd ../frontend
            nohup python3 -m http.server 8080 > frontend.log 2>&1 &
          EOF
